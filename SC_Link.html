<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업무 현황 대시보드 (최종)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; }
        .custom-table { width: 100%; font-size: 12px; text-align: center; border-collapse: separate; border-spacing: 0; }
        .custom-table th { background-color: #f3f4f6; padding: 8px; border: 1px solid #e5e7eb; font-weight: 700; white-space: nowrap; }
        .custom-table td { padding: 8px; border: 1px solid #e5e7eb; white-space: nowrap; }
        .section-container { background: white; border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chart-mini-box { border: 1px solid #f1f1f1; border-radius: 8px; padding: 10px; background: #fff; }
    </style>
</head>
<body class="text-gray-800 max-w-[1920px] mx-auto p-4">

    <!-- 로딩 화면 -->
    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center text-center p-4">
        <div id="spinner">
            <i class="fa-solid fa-circle-notch fa-spin text-5xl text-blue-500 mb-4"></i>
            <p class="text-xl font-bold text-gray-700">데이터 연결 중...</p>
            <p class="text-sm text-gray-500 mt-2">보안 연결을 우회하여 데이터를 가져옵니다.</p>
        </div>
        <!-- 에러 로그 -->
        <div id="error-log" class="hidden max-w-2xl bg-red-50 border border-red-200 rounded-lg p-6 mt-4 text-left">
            <h3 class="text-red-600 font-bold text-lg mb-2">오류 발생</h3>
            <p id="error-message" class="text-sm text-red-800 font-mono mb-4"></p>
            <button onclick="location.reload()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">다시 시도</button>
        </div>
    </div>

    <main id="main-content" class="hidden">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">초격차 서비스팀 업무 현황</h1>
                <p class="text-sm text-gray-500">갱신: <span id="last-update">-</span></p>
            </div>
            <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700"><i class="fa-solid fa-rotate-right"></i></button>
        </header>

        <!-- SECTION 1 -->
        <div class="section-container border-t-4 border-blue-500">
            <h2 class="text-lg font-bold mb-4 text-blue-700">Part 1. 케어 서비스 업무 수행 현황</h2>
            <div class="overflow-x-auto mb-6 border rounded-lg"><table class="custom-table" id="table-section-1"></table></div>
            <div class="flex flex-col xl:flex-row gap-6 h-[320px]">
                <div class="xl:w-1/4 border rounded-lg p-4 relative flex flex-col"><canvas id="donut-1"></canvas></div>
                <div class="xl:w-3/4 border rounded-lg p-4 overflow-y-auto"><div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="grid-charts-1"></div></div>
            </div>
        </div>

        <!-- SECTION 2 -->
        <div class="section-container border-t-4 border-green-500">
            <h2 class="text-lg font-bold mb-4 text-green-700">Part 2. 일상 반복 업무 / 근태 현황</h2>
            <div class="overflow-x-auto mb-6 border rounded-lg"><table class="custom-table" id="table-section-2"></table></div>
            <div class="flex flex-col xl:flex-row gap-6 h-[320px]">
                <div class="xl:w-1/4 border rounded-lg p-4 relative flex flex-col"><canvas id="donut-2"></canvas></div>
                <div class="xl:w-3/4 border rounded-lg p-4 overflow-y-auto"><div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="grid-charts-2"></div></div>
            </div>
        </div>
    </main>

    <script>
        // 원본 구글 시트 주소
        const ORIGINAL_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRW2X0n-wIhYgHvehfoIToj_wmZhvMjcXtysn5BK_dkValj16OFoRPBNgpPiITRGtg-ev7k72KCTET8/pub?gid=0&single=true&output=csv";
        
        // [해결책] CORS 우회 프록시 사용 (api.allorigins.win)
        // 이 방식을 사용하면 로컬 파일(file://)에서도 데이터를 불러올 수 있습니다.
        const PROXY_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(ORIGINAL_SHEET_URL)}`;

        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];

        document.addEventListener('DOMContentLoaded', () => {
            Papa.parse(PROXY_URL, {
                download: true,
                header: false,
                skipEmptyLines: false,
                complete: function(results) {
                    if (!results.data || results.data.length === 0) {
                        showError("데이터가 비어있습니다.");
                        return;
                    }
                    try {
                        parseAndRender(results.data);
                        document.getElementById('loader').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
                    } catch (e) {
                        console.error(e);
                        showError("데이터 해석 중 오류 발생: " + e.message);
                    }
                },
                error: function(err) {
                    console.error(err);
                    // 프록시 실패 시 원본으로 재시도 (혹시 서버 환경일 경우를 대비)
                    console.log("프록시 실패, 원본 URL로 재시도...");
                    retryOriginal();
                }
            });
        });

        function retryOriginal() {
            Papa.parse(ORIGINAL_SHEET_URL, {
                download: true,
                header: false,
                skipEmptyLines: false,
                complete: function(results) {
                    try {
                        parseAndRender(results.data);
                        document.getElementById('loader').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                    } catch(e) { showError("최종 연결 실패: 브라우저 보안 정책으로 인해 로컬 실행이 차단되었습니다."); }
                },
                error: function() { showError("최종 연결 실패. 인터넷 연결을 확인하세요."); }
            });
        }

        function showError(msg) {
            document.getElementById('spinner').classList.add('hidden');
            document.getElementById('error-log').classList.remove('hidden');
            document.getElementById('error-message').innerText = msg;
        }

        // --- 파싱 로직 (기존과 동일) ---
        function parseAndRender(rows) {
            let firstHeaderIdx = findHeaderIndex(rows);
            if (firstHeaderIdx === -1) throw new Error("데이터에서 '담당자' 행을 찾을 수 없습니다.");

            let secondHeaderIdx = -1;
            for(let i = firstHeaderIdx + 1; i < rows.length; i++) {
                if(rows[i] && rows[i].join('').includes("담당자")) { secondHeaderIdx = i; break; }
            }

            const section1 = rows.slice(firstHeaderIdx, secondHeaderIdx > 0 ? secondHeaderIdx : 10);
            const section2 = secondHeaderIdx > 0 ? rows.slice(secondHeaderIdx) : [];

            if(section1.length > 0) processSection(section1, 'table-section-1', 'donut-1', 'grid-charts-1');
            if(section2.length > 0) processSection(section2, 'table-section-2', 'donut-2', 'grid-charts-2');
        }

        function findHeaderIndex(rows) {
            for(let i=0; i<rows.length; i++) { if(rows[i] && rows[i].join('').includes("담당자")) return i; }
            return -1;
        }

        function processSection(dataRows, tableId, donutId, gridId) {
            const headerRow = dataRows[0];
            const categories = [];
            for(let i=3; i<headerRow.length; i+=2) {
                if(headerRow[i] && headerRow[i].trim()) categories.push({ name: headerRow[i], index: i });
            }

            const people = [];
            let totalRow = null;

            for(let i=1; i<dataRows.length; i++) {
                const row = dataRows[i];
                const name = row[0];
                if(!name) continue;
                if(name.includes("합") && name.includes("계")) { totalRow = row; continue; }
                if(name.includes("담당자")) continue;

                const totalValRaw = row[1];
                const personData = { name: name, totalStr: totalValRaw, total: parseNum(totalValRaw), values: [] };

                categories.forEach(cat => {
                    personData.values.push({ val: parseNum(row[cat.index]), raw: row[cat.index] });
                });
                people.push(personData);
            }

            renderTable(tableId, headerRow, categories, people, totalRow);
            renderDonut(donutId, people.map(p=>p.name), people.map(p=>p.total));
            renderGridCharts(gridId, categories, people, people.map(p=>p.name));
        }

        function parseNum(str) {
            if(!str) return 0;
            return parseFloat(str.replace(/[^0-9.]/g, '')) || 0;
        }

        function renderTable(id, header, cats, people, totalRow) {
            const table = document.getElementById(id);
            let h = `<thead><tr><th class="bg-gray-100">담당자</th><th class="bg-orange-50">${header[1]}</th><th>비율</th>`;
            cats.forEach(c => h += `<th>${c.name}</th><th>비율</th>`);
            h += `</tr></thead><tbody>`;

            people.forEach(p => {
                const grandTotal = totalRow ? parseNum(totalRow[1]) : 1;
                const ratio = grandTotal ? Math.round(p.total/grandTotal*100) : 0;
                h += `<tr><td class="font-bold bg-gray-50">${p.name}</td><td class="text-blue-600 font-bold">${p.totalStr}</td><td class="text-xs text-gray-400">${ratio}%</td>`;
                p.values.forEach((v, idx) => {
                    const catTotal = totalRow ? parseNum(totalRow[cats[idx].index]) : 1;
                    const catRatio = catTotal ? Math.round(v.val/catTotal*100) : 0;
                    h += `<td>${v.raw||'-'}</td><td class="text-xs text-gray-400">${v.val>0?catRatio+'%':'-'}</td>`;
                });
                h += `</tr>`;
            });

            if(totalRow) {
                h += `<tr class="bg-orange-100 font-bold"><td>합계</td><td class="text-orange-700">${totalRow[1]}</td><td>-</td>`;
                cats.forEach(c => h += `<td>${totalRow[c.index]}</td><td>-</td>`);
                h += `</tr>`;
            }
            table.innerHTML = h + `</tbody>`;
        }

        function renderDonut(id, labels, data) {
            new Chart(document.getElementById(id), {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: COLORS, borderWidth:1 }] },
                options: { plugins: { legend: {position:'bottom'}, datalabels: {color:'#fff', formatter:(v,c)=>{
                    let s=0; c.chart.data.datasets[0].data.map(d=>s+=d);
                    return (v/s*100).toFixed(0)+'%';
                }} } },
                plugins: [ChartDataLabels]
            });
        }

        function renderGridCharts(id, cats, people, labels) {
            const box = document.getElementById(id);
            box.innerHTML = '';
            cats.forEach((c, idx) => {
                const d = document.createElement('div');
                d.className = 'chart-mini-box';
                d.innerHTML = `<div class="text-xs font-bold mb-1">${c.name}</div><div style="height:80px"><canvas></canvas></div>`;
                box.appendChild(d);
                const vals = people.map(p=>p.values[idx].val);
                if(Math.max(...vals)===0) return;
                new Chart(d.querySelector('canvas'), {
                    type: 'bar',
                    data: { labels, datasets: [{ data: vals, backgroundColor: COLORS[idx%COLORS.length] }] },
                    options: { indexAxis:'y', plugins:{legend:false, datalabels:{anchor:'end', align:'end', formatter:v=>v>0?v:''}}, scales:{x:{display:false}, y:{display:false}} },
                    plugins: [ChartDataLabels]
                });
            });
        }
    </script>
</body>
</html>